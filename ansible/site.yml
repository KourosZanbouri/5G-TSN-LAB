---
- name: Prepare all nodes for 5G/TSN
  hosts: all
  become: yes
  vars:
    # 5G/TSN specific kernel modules
    kernel_modules:
      - br_netfilter
      - overlay
      - sctp  # 5G Control Plane
      - gtp   # 5G User Plane
  tasks:
    # ---------------------------------------------------------
    # 1. SYSTEM CONFIGURATION
    # ---------------------------------------------------------
    - name: Disable Swap (Required for K8s)
      shell: |
        swapoff -a
        sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

    # --- NEW FIX STARTS HERE ---
    - name: Install extra kernel modules (Required for GTP)
      apt:
        name: "linux-modules-extra-{{ ansible_kernel }}"
        state: present
        update_cache: yes
    # --- NEW FIX ENDS HERE ---

    - name: Load Kernel Modules
      modprobe:
        name: "{{ item }}"
        state: present
      loop: "{{ kernel_modules }}"

    - name: Configure Sysctl for Kubernetes networking
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/k8s.conf
        reload: yes
      with_dict:
        net.bridge.bridge-nf-call-iptables: 1
        net.ipv4.ip_forward: 1
        net.ipv6.conf.all.forwarding: 1
    # ---------------------------------------------------------
    # 2. INSTALLATION (With Retry Logic)
    # ---------------------------------------------------------
    - name: Wait for automatic system updates to complete
      shell: while fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 5; done;

    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install Containerd
      apt:
        name: containerd
        state: present

    - name: Configure Containerd (Systemd Cgroup)
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
      notify: Restart Containerd

    - name: Install Transport HTTPS & Curl
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gpg
        state: present

    - name: Add Kubernetes GPG Key
      shell: |
        if [ ! -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg ]; then
          curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        fi

    - name: Add Kubernetes APT Repository
      shell: |
        echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | tee /etc/apt/sources.list.d/kubernetes.list

    - name: Install Kubeadm, Kubelet, Kubectl
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
        update_cache: yes

    - name: Hold Kubernetes packages (prevent auto-upgrade)
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl

  handlers:
    - name: Restart Containerd
      service: name=containerd state=restarted

# ---------------------------------------------------------
# 3. MASTER NODE INITIALIZATION
# ---------------------------------------------------------
- name: Initialize Master
  hosts: masters
  become: yes
  tasks:
    - name: Check if cluster is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_conf

    - name: Initialize Kubeadm (Only if not already done)
      command: kubeadm init --pod-network-cidr=10.244.0.0/16
      register: kubeadm_init
      when: not k8s_conf.stat.exists

    - name: Create .kube directory for ubuntu user
      shell: |
        mkdir -p /home/ubuntu/.kube
        cp -f /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
        chown ubuntu:ubuntu /home/ubuntu/.kube/config

    - name: Install Flannel CNI (Networking)
      become: no # Run as regular user
      command: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      when: not k8s_conf.stat.exists

    - name: Get Join Command
      command: kubeadm token create --print-join-command
      register: join_command_output

    - name: Set Join Command Variable
      set_fact:
        join_command: "{{ join_command_output.stdout_lines[0] }}" 
        # .stdout_lines[0] is safer than .stdout as it ignores trailing newlines

# ---------------------------------------------------------
# 4. WORKER NODE JOIN
# ---------------------------------------------------------
- name: Join Workers
  hosts: workers
  become: yes
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Join cluster
      command: "{{ hostvars[groups['masters'][0]]['join_command'] }}"
      when: not kubelet_conf.stat.exists